{% extends "template.html" %}

{% load util %}

{% block title %}[Usuários do Grupo de Usuários - Listagem]{% endblock %}

{% block header %}
<script type="text/javascript">
$(document).ready(function() {
	
	oTable_user = $("#ugrops_list").dataTable({
		"aaSorting": [],
		"bJQueryUI": true,
		"sPaginationType": "full_numbers",
		"iDisplayLength": {% max_results %},
		"aoColumnDefs": [{ "bSortable": false, "aTargets": [ 0 ] }],
		"aoColumns": [null, null, null, { "sType": "check" }  ]
	});
	
	$("#checkAll_user").click( function() {
		if ($(this).attr('checked')) {
			$("#ugrops_list :checkbox").attr("checked", true);
		} else {
			$("#ugrops_list :checkbox").attr("checked", false);
		}
	});
	
	$("#page_tab").tabs();
	$("#page_tab_lists").tabs({ selected: {{tab}} });
	$("#page_tab_form_user").tabs();
	$("#page_tab_form_perm").tabs();
	
	$("#page_tab_form_user").hide();
	$("#page_tab_form_perm").hide();
	
	$("#tool_user").buttonset();
	$("#tool_perm").buttonset();
	
	$("#id_users").pickList();
	
	$(".pickList_addAll").button({ icons: {primary: "ui-icon-arrowthickstop-1-s"}, text: false });
	$(".pickList_add").button({ icons: {primary: "ui-icon-arrowthick-1-s"}, text: false });
	$(".pickList_remove").button({ icons: {primary: "ui-icon-arrowthick-1-n"}, text: false });
	$(".pickList_removeAll").button({ icons: {primary: "ui-icon-arrowthickstop-1-n"}, text: false });
	
	
	{% ifequal tab '0' %}
	
		{% ifequal open_form 'True' %}
			$('html, body').animate({
			    scrollTop: $("#page_tab_form_user").show(1000).offset().top
			}, 2000);
		{% endifequal %}
	
	{% else %}
	
		{% ifequal open_form 'True' %}
			$('html, body').animate({
			    scrollTop: $("#page_tab_form_perm").show(1000).offset().top
			}, 2000);
		{% endifequal %}

	{% endifequal %}	
	
	$("#btn_new_user").button({ icons: {primary: "ui-icon-document"} }).click(function(){
		$("#form_user").clearForm();
		$("#form_user").attr('action', '{{ action_new_users }}');
		$("#form_user .user").html('');
		$('.pickList_removeAll').click();
		$('html, body').animate({
		    scrollTop: $("#page_tab_form_user").show(1000).offset().top
		}, 2000);
		
	});
	
	$("#btn_sav_user").button({ icons: {primary: "ui-icon-disk"} });
	
	$("#btn_can_user").button({ icons: {primary: "ui-icon-cancel"} }).click(function(){
		$("#page_tab_form_user").hide(2000);
	});
	
	{% has_perm ADMINISTRATION True None %}
	{% if has_perm %}
	$("#btn_del_user").button({ icons: {primary: "ui-icon-trash"} }).click(function(){
		if (confirm('Deseja realmente desassociar o(s) usuários selecionado(s) com grupo ?')){ 
			var data = getSelectionData(oTable_user);
			$("#id_ids").val(data).parent().submit();
		}
	});
	{% endif %}
	
	$("#btn_ref_user").button({ icons: {primary: "ui-icon-refresh"} }).click(function(){
		location.href = "{% url user-group.list ugroup.id 0 %}";
	});
	
	$(".voltar").button({ icons: {primary: "ui-icon-arrowthick-1-w"} }).click(function(){
		location.href = "{% url group-user.list %}";
	});
	
	oTable_perms = $("#perms_list").dataTable({
		"aaSorting": [],
		"bJQueryUI": true,
		"sPaginationType": "full_numbers",
		"iDisplayLength": {% max_results %},
		"aoColumnDefs": [{ "bSortable": false, "aTargets": [ 0, 4 ] }],
		"aoColumns": [null, null, { "sType": "check" }, { "sType": "check" }, null  ]
	});
	
	$("#checkAll_perm").click( function() {
		if ($(this).attr('checked')) {
			$("#perms_list :checkbox").attr("checked", true);
		} else {
			$("#perms_list :checkbox").attr("checked", false);
		}
	});
	
	$("#btn_new_perm").button({ icons: {primary: "ui-icon-document"} }).click(function(){
		$("#form_perm").clearForm();
		$("#form_perm").attr('action', '{{ action_new_perms }}');
		$("#form_perm .perm").html('');
		$('html, body').animate({
		    scrollTop: $("#page_tab_form_perm").show(1000).offset().top
		}, 2000);
	});
	
	$("#btn_sav_perm").button({ icons: {primary: "ui-icon-disk"} });
	
	$("#btn_can_perm").button({ icons: {primary: "ui-icon-cancel"} }).click(function(){
		$("#page_tab_form_perm").hide(2000);
	});
	
	{% has_perm ADMINISTRATION True None %}
	{% if has_perm %}
	$("#btn_del_perm").button({ icons: {primary: "ui-icon-trash"} }).click(function(){
		if (confirm('Deseja realmente excluir a(s) Permissão Administrativa selecionada(s)?')){
			var data = getSelectionData(oTable_perms);
			$("#id_ids_aux").val(data).parent().submit();
		}
	});
	{% endif %}
	
	$("#btn_ref_perm").button({ icons: {primary: "ui-icon-refresh"} }).click(function(){
		location.href = "{% url user-group.list ugroup.id 1 %}";
	});
	
	$( "#id_function" ).autocomplete({ source: [{% for suggestion in suggestion_perm %} '{{ suggestion }}', {% endfor %}] });
	
	$(".btn_edit").button({ icons: {primary: "ui-icon-pencil"}, text: false });
	$(".btn_edit", oTable_perms.fnGetHiddenNodes()).button({ icons: {primary: "ui-icon-pencil"}, text: false });
	
	
})
</script>
{% endblock %}

{% block content %}
<div id="page_tab">
	<ul>
		<li><span class="ui-icon ui-icon-triangle-1-e page_tab_icon"></span><a href="#tabs-1">Detalhes do Grupo de usuários</a></li>
	</ul>
	<div id="tabs-1">
		{% csrf_token %}

		<div id="fields" class="ui-widget-content">
			<table border="5">
				<tr>
					<td style="width: 120px"><label for="nome_ambiente">Nome do Grupo</label></td>
					<td><label style="width: 350px;color: blue;text-align: center;" >{{ugroup.nome}}</label></td>
				</tr>
				<tr>
					<td><label>Leitura</label></td>
					<td class="text_center">{% ifequal ugroup.leitura 'S' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
				</tr>
				<tr>
					<td><label>Escrita</label></td>
					<td class="text_center">{% ifequal ugroup.escrita 'S' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
				</tr>
				<tr>
					<td><label>Edição</label></td>
					<td class="text_center">{% ifequal ugroup.edicao 'S' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
				</tr>
				<tr>
					<td><label>Exclusão</label></td>
					<td class="text_center">{% ifequal ugroup.exclusa 'S' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
				</tr>
			</table>
		</div>
		
		<div class="separator spacer"></div>
		
		<div>
		
			<div id="page_tab_lists">
				<ul>
					<li><span class="ui-icon ui-icon-triangle-1-e page_tab_icon"></span><a href="#tabs-1">Usuários</a></li>
					<li><span class="ui-icon ui-icon-triangle-1-e page_tab_icon"></span><a href="#tabs-2">Permissão Administrativa</a></li>
				</ul>
				<div id="tabs-1">
					<div class="buttons">
						<button title="voltar" class="voltar">Voltar</button>
						<button id="btn_ref_user" title="Atualizar dados da listagem">Atualizar</button>
						<span id="tool_user">
						<button id="btn_new_user">Novo Registro</button>
						{% has_perm ADMINISTRATION True None %}
						{% if has_perm %}
						<button id="btn_del_user">Excluir</button>
						{% endif %}
						</span>
					</div>
					{% has_perm ADMINISTRATION True None %}
					{% if has_perm %}
					<form id="delete_form_user" method="post" action="{% url user-group.delete ugroup.id  %}" style="visibility: hidden;">
						{% csrf_token %}
						{% for field in form %}
							{{ field }}
						{% endfor %}
					</form>
					{% endif %}
					<table id="ugrops_list">
						<thead>
							<tr>
								<th><input id="checkAll_user" type="checkbox" /></th>
								<th>Nome</th>
								<th>E-mail</th>
								<th>Ativo</th>
							</tr>
						</thead>
						<tbody>
							{% for user in users %}
							<tr>
								<td class="text_center"><input type="checkbox" class="checkbox_user" name="selection" value="{{ user.id }}" /></td>
								<td class="text_center">{{ user.nome }}</td>
								<td class="text_center">{{ user.email }}</td>
								<td class="text_center">{% ifequal user.ativo 'True' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
					
					<br>
					
					{% has_perm ADMINISTRATION True None %}
					{% if has_perm %}					
						<div id="page_tab_form_user">
							<ul>
								<li><span class="ui-icon ui-icon-triangle-1-e page_tab_icon"></span><a href="#tabs-1">Cadastro de Usuário</a></li>
							</ul>
							<div id="tabs-1">
								<form id="form_user" method="post" action="{% url user-group.form ugroup.id %}">
									{% csrf_token %}
									<div id="fields" class="ui-widget-content">
									{% for field in form_users %}
										<div>
											<div><label for="{{ field.auto_id }}">{{ field.label_tag }}{% if field.field.required %}<span style="color: red;">*</span>{% endif %}</label></div>
											 {{ field }}
											<p id="error" class="user">
											{% if field.errors %} 
												{% for error in field.errors %}
													{{ error|escape }}
												{% endfor %}
											{% endif %}
											</p>
										</div>
									{% endfor %}
									</div>
									
									<div class="separator spacer"></div>
									
									<div class="buttons-l ui-widget-header">
										<button id="btn_sav_user" type="submit">Gravar</button>
										<button id="btn_can_user" type="button">Cancelar</button>
									</div>
								</form>
							</div>
						</div>					
					{% endif %}

				</div>
				
				<!-- ----------------------------------------------------- -->
				
				<div id="tabs-2">
					<div class="buttons">
						<button title="voltar" class="voltar">Voltar</button>
						<button id="btn_ref_perm" title="Atualizar dados da listagem">Atualizar</button>
						<span id="tool_perm">
						<button id="btn_new_perm">Novo Registro</button>
						{% has_perm ADMINISTRATION True None %}
						{% if has_perm %}
						<button id="btn_del_perm">Excluir</button>
						{% endif %}
						</span>
					</div>
					{% has_perm ADMINISTRATION True None %}
					{% if has_perm %}
					<form id="delete_form_perm" method="post" action="{% url user-group-perm.delete ugroup.id  %}" style="visibility: hidden;">
						{% csrf_token %}
						{% for field in form_aux %}
							{{ field }}
						{% endfor %}
					</form>
					{% endif %}
					<table id="perms_list">
						<thead>
							<tr>
								<th><input id="checkAll_perm" type="checkbox" /></th>
								<th>Função</th>
								<th>Leitura</th>
								<th>Escrita</th>
								<th></th>
							</tr>
						</thead>
						<tbody>
							{% for perm in perms %}
							<tr>
								<td class="text_center"><input type="checkbox" name="selection" value="{{ perm.id }}" /></td>
								<td class="text_center">{{ perm.funcao }}</td>
								<td class="text_center">{% ifequal perm.leitura 'True' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
								<td class="text_center">{% ifequal perm.escrita 'True' %} <span class="ui-icon ui-icon-check text_center" title="SIM"></span> {% else %} <span class="ui-icon ui-icon-close text_center" title="NÃO"></span>  {% endifequal %}</td>
								<td class="text_center"><a href="{% url user-group-perm.edit ugroup.id perm.id %}" style="width: 20px; height: 20px;" class="btn_edit">Editar</a></td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
					
					<br>
					
					{% has_perm ADMINISTRATION True None %}
					{% if has_perm %}					
						<div id="page_tab_form_perm">
							<ul>
								<li><span class="ui-icon ui-icon-triangle-1-e page_tab_icon"></span><a href="#tabs-2">Cadastro de Permissão Administrativa</a></li>
							</ul>
							<div id="tabs-2">
								<form id="form_perm" method="post" action="{{ action_edit_perms }}">
									{% csrf_token %}
									<div id="fields" class="ui-widget-content">
									{% for field in form_perms %}
										<div>
											<div><label for="{{ field.auto_id }}">{{ field.label_tag }}{% if field.field.required %}<span style="color: red;">*</span>{% endif %}</label>
											 {% ifequal field.field.label 'Função' %} </div>{{ field }} {% else %} {{ field }}</div> {% endifequal %}
											<p id="error" class="perm">
											{% if field.errors %} 
												{% for error in field.errors %}
													{{ error|escape }}
												{% endfor %}
											{% endif %}
											</p>
										</div>
									{% endfor %}
									</div>
									
									<div class="separator spacer"></div>
									
									<div class="buttons-l ui-widget-header">
										<button id="btn_sav_perm" type="submit">Gravar</button>
										<button id="btn_can_perm" type="button">Cancelar</button>
									</div>
								</form>
							</div>
						</div>					
					{% endif %}
					
				</div>
				
					
			</div>
			</div>
		</div>
		
	</div>
				
{% endblock %}